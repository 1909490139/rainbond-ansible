---
- name: Thirdparty | Check Docker Daemon
  stat: path=/etc/docker/daemon.json
  register: check_docker_daemon

- name: Thirdparty | Write docker daemon
  template: 
    src: daemon.json.j2 
    dest: /etc/docker/daemon.json
  when: check_docker_daemon.stat.isreg is not defined

- name: Thirdparty | check admin.kubeconfig
  stat: path="/opt/rainbond/etc/kubernetes/kubecfg/admin.kubeconfig"
  register: check_admin_kubeconfig
  delegate_to: "{{ groups.deploy[0] }}"

- name: Thirdparty | Copy admin.kubeconfig
  template: 
    src: /root/.kube/config
    dest: /opt/rainbond/etc/kubernetes/kubecfg/admin.kubeconfig
  when: check_admin_kubeconfig.stat.isreg is not defined
  delegate_to: "{{ groups.deploy[0] }}"

- name: Thirdparty | Copy kube-proxy.kubeconfig
  template: 
    src: /root/.kube/config
    dest: /opt/rainbond/etc/kubernetes/kubecfg/kube-proxy.kubeconfig
  when: check_admin_kubeconfig.stat.isreg is not defined
  delegate_to: "{{ groups.deploy[0] }}"

- name: Thirdparty | check kubectl
  stat: path="/usr/local/bin/kubectl"
  register: check_kubectl

- name: Thirdparty | Copy kubectl
  copy:
    src: /usr/bin/kubectl
    dest: /usr/local/bin/kubectl
    mode: '0777'
    backup: yes
  when: check_kubectl.stat.isreg is not defined

- name: Thirdparty | check k8s master
  stat: path=/etc/kubernetes/manifests/kube-apiserver.yaml
  register: check_k8s_master

- name: Thirdparty | Add Health Only Health Role
  template:
    src: thirdparty-k8s-master.yaml.j2
    dest: "{{ node_role_dir }}/thirdparty_k8s_master.yaml.j2"
  when: check_k8s_master.stat.isreg is defined

- name: Thirdparty | check kubectl worker
  stat: path=/etc/kubernetes/kubelet.conf
  register: check_k8s_worker

- name: Thirdparty | Add Health Only Health Role
  template:
    src: thirdparty-k8s-worker.yaml.j2
    dest: "{{ node_role_dir }}/thirdparty_k8s_worker.yaml.j2"
  when: check_k8s_worker.stat.isreg is defined
